<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Form Alamat Kelurahan</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
#results { max-height:300px; overflow-y:auto; border:1px solid #ddd; }
.result-item { padding:8px; cursor:pointer; border-bottom:1px solid #eee; }
.result-item:hover { background:#f8f9fa; }
</style>
</head>
<body class="bg-light">

<div class="container py-5">
  <h3 class="mb-4">Form Alamat dengan Autocomplete Kelurahan</h3>
  
  <div class="mb-3">
    <label class="form-label">Kelurahan / Desa</label>
    <input type="text" id="kelurahan" class="form-control" placeholder="Ketik nama kelurahan...">
    <div id="results"></div>
  </div>
  
  <div class="mb-3">
    <label class="form-label">Kecamatan</label>
    <input type="text" id="kecamatan" class="form-control" readonly>
  </div>
  
  <div class="mb-3">
    <label class="form-label">Kabupaten / Kota</label>
    <input type="text" id="kabupaten" class="form-control" readonly>
  </div>
  
  <div class="mb-3">
    <label class="form-label">Provinsi</label>
    <input type="text" id="provinsi" class="form-control" readonly>
  </div>
</div>

<script>
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzGuxuqEVW3QLnaK0IEqTgF3tepHyaY9OqlQv1nl7ijAmNOREeV9HrMB6upIPWLeHiA/exec";
let timeout;

document.getElementById('kelurahan').addEventListener('input', function() {
  const keyword = this.value.trim();
  const resultsDiv = document.getElementById('results');
  clearTimeout(timeout);

  if (keyword.length < 3) {
    resultsDiv.innerHTML = "<div class='p-2 text-muted'>Ketik minimal 3 huruf...</div>";
    return;
  }

  resultsDiv.innerHTML = "<div class='p-2 text-primary'>Mencari...</div>";

  timeout = setTimeout(async () => {
    try {
      const res = await fetch(`${GAS_WEB_APP_URL}?keyword=${encodeURIComponent(keyword)}`);
      const data = await res.text(); // langsung parse JSON
      console.log(data); // bisa di-uncomment untuk debugging

      if (data.error) {
        resultsDiv.innerHTML = `<div class='p-2 text-danger'>${data.error}</div>`;
        return;
      }

      if (!data.data || data.data.length === 0) {
        resultsDiv.innerHTML = "<div class='p-2 text-danger'>Tidak ada hasil ditemukan</div>";
        return;
      }

      resultsDiv.innerHTML = data.data.slice(0,50).map(item => `
        <div class="result-item" 
             data-kel="${item.desakel}" 
             data-kec="${item.kecamatan}" 
             data-kab="${item.kabkota}" 
             data-prov="${item.provinsi}">
          <strong>${item.desakel}</strong><br>
          <small>${item.kecamatan}, ${item.kabkota}, ${item.provinsi}</small>
        </div>
      `).join('');

      document.querySelectorAll('.result-item').forEach(el => {
        el.addEventListener('click', () => {
          document.getElementById('kelurahan').value = el.dataset.kel;
          document.getElementById('kecamatan').value = el.dataset.kec;
          document.getElementById('kabupaten').value = el.dataset.kab;
          document.getElementById('provinsi').value = el.dataset.prov;
          resultsDiv.innerHTML = "";
        });
      });

    } catch(err) {
      resultsDiv.innerHTML = "<div class='p-2 text-danger'>Gagal mengambil data</div>";
      console.error(err);
    }
  }, 400); // debounce 400ms
});
</script>

</body>
</html>
